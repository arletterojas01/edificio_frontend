<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="bi bi-plus-circle me-2"></i>
          Crear Nuevo Ticket
        </h1>
        <button class="btn btn-outline-secondary" (click)="cancel()">
          <i class="bi bi-arrow-left me-1"></i>
          Volver
        </button>
      </div>

      <!-- Formulario -->
      <div class="card">
        <div class="card-body">
          <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()">
            
            <!-- Título -->
            <div class="mb-3">
              <label for="titulo" class="form-label">Título del Problema *</label>
              <input
                type="text"
                class="form-control"
                id="titulo"
                formControlName="titulo"
                [class.is-invalid]="submitted && f['titulo']?.errors"
                placeholder="Ej: Fuga de agua en cocina">
              <div *ngIf="submitted && f['titulo']?.errors" class="invalid-feedback">
                <div *ngIf="f['titulo']?.errors?.['required']">El título es requerido</div>
                <div *ngIf="f['titulo']?.errors?.['minlength']">Mínimo 5 caracteres</div>
                <div *ngIf="f['titulo']?.errors?.['maxlength']">Máximo 200 caracteres</div>
              </div>
            </div>

            <!-- Descripción -->
            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción Detallada *</label>
              <textarea
                class="form-control"
                id="descripcion"
                formControlName="descripcion"
                [class.is-invalid]="submitted && f['descripcion']?.errors"
                rows="4"
                placeholder="Describe el problema en detalle..."></textarea>
              <div *ngIf="submitted && f['descripcion']?.errors" class="invalid-feedback">
                <div *ngIf="f['descripcion']?.errors?.['required']">La descripción es requerida</div>
                <div *ngIf="f['descripcion']?.errors?.['minlength']">Mínimo 10 caracteres</div>
              </div>
            </div>

            <!-- Categoría y Prioridad -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="categoria" class="form-label">Categoría *</label>
                  <select
                    class="form-select"
                    id="categoria"
                    formControlName="categoria"
                    [class.is-invalid]="submitted && f['categoria']?.errors">
                    <option value="">Seleccionar categoría</option>
                    <option *ngFor="let categoria of categorias" [value]="categoria.id_categoria">
                      {{ categoria.nombre }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['categoria']?.errors" class="invalid-feedback">
                    La categoría es requerida
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="prioridad" class="form-label">Prioridad *</label>
                  <select
                    class="form-select"
                    id="prioridad"
                    formControlName="prioridad"
                    [class.is-invalid]="submitted && f['prioridad']?.errors">
                    <option *ngFor="let prioridad of prioridades" [value]="prioridad.value">
                      {{ prioridad.label }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Ubicación -->
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="ubicacion" class="form-label">Ubicación</label>
                  <input
                    type="text"
                    class="form-control"
                    id="ubicacion"
                    formControlName="ubicacion"
                    placeholder="Ej: Cocina, Baño principal">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="piso" class="form-label">Piso</label>
                  <input
                    type="text"
                    class="form-control"
                    id="piso"
                    formControlName="piso"
                    placeholder="Ej: 2">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="departamento" class="form-label">Departamento</label>
                  <input
                    type="text"
                    class="form-control"
                    id="departamento"
                    formControlName="departamento"
                    placeholder="Ej: 201">
                </div>
              </div>
            </div>

            <!-- Área específica -->
            <div class="mb-3">
              <label for="area" class="form-label">Área Específica</label>
              <input
                type="text"
                class="form-control"
                id="area"
                formControlName="area"
                placeholder="Ej: Bajo el fregadero, Puerta principal">
            </div>

            <!-- Imágenes -->
            <div class="mb-4">
              <label class="form-label">Imágenes del Problema</label>
              <input
                type="file"
                class="form-control"
                (change)="onFileSelected($event)"
                multiple
                accept="image/*">
              
              <!-- Preview de imágenes -->
              <div *ngIf="selectedFiles.length > 0" class="mt-2">
                <div class="d-flex flex-wrap gap-2">
                  <div *ngFor="let file of selectedFiles; let i = index" class="position-relative">
                    <img [src]="getImagePreview(file)" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                    <button type="button" class="btn-close position-absolute top-0 end-0 bg-white" (click)="removeFile(i)"></button>
                  </div>
                </div>
                <small class="text-muted">{{ selectedFiles.length }} imagen(es) seleccionada(s)</small>
              </div>
            </div>

            <!-- Error Message -->
            <div *ngIf="error" class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ error }}
            </div>

            <!-- Botones -->
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-outline-secondary" (click)="cancel()">
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                <i class="bi bi-check-circle me-1" *ngIf="!loading"></i>
                {{ loading ? 'Creando...' : 'Crear Ticket' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>